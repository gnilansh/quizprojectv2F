
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Quiz Master Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body, html { margin:0; padding:0; height:100%; background:#f0f2f5; font-family:sans-serif; }
    #adminApp { max-width:960px; margin:1rem auto; }
    .card { margin-bottom:1.5rem; }
    .card-header { font-weight: 600; }
    .toast-container { position:fixed; top:1rem; right:1rem; z-index:1055; }
  </style>
</head>
<body>
<div id="adminApp">
    <div class="toast-container">
      <div v-if="toast.visible" class="toast align-items-center text-white border-0 show"
           :class="'bg-' + toast.variant" role="alert">
        <div class="d-flex">
          <div class="toast-body">{{ toast.message }}</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" @click="toast.visible=false"></button>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">Users</div>
      <div class="card-body">
        <input v-model="userSearch" @input="loadUsers" class="form-control mb-2" placeholder="Search users…">
        <ul class="list-group">
          <li v-for="u in users" :key="u.id" class="list-group-item d-flex justify-content-between align-items-center">
            <span>{{ u.full_name }} <small class="text-muted">({{ u.email }})</small></span>
            <button class="btn btn-sm btn-outline-primary" @click="openScoresModal(u.id)">Scores</button>
          </li>
          <li v-if="!users.length" class="list-group-item text-muted">No users found.</li>
        </ul>
      </div>
    </div>

    <div class="card">
      <div class="card-header">Subjects</div>
      <div class="card-body">
        <div class="input-group mb-3">
          <input v-model="newSubject.name" class="form-control" placeholder="New Subject Name">
          <input v-model="newSubject.description" class="form-control" placeholder="Description">
          <button class="btn btn-primary" @click="createSubject">Add</button>
        </div>
        <ul class="list-group">
          <li v-for="s in subjects" :key="s.id" class="list-group-item d-flex justify-content-between align-items-center">
            <div class="flex-fill pe-2">
              <input v-model="s.name" class="form-control form-control-sm mb-1" placeholder="Name">
              <input v-model="s.description" class="form-control form-control-sm" placeholder="Description">
            </div>
            <div>
              <button class="btn btn-sm btn-success me-1" @click="updateSubject(s)">Save</button>
              <button class="btn btn-sm btn-danger" @click="deleteSubject(s.id)">Delete</button>
            </div>
          </li>
          <li v-if="!subjects.length" class="list-group-item text-muted">No subjects.</li>
        </ul>
      </div>
    </div>

    <div class="card">
      <div class="card-header">Chapters</div>
      <div class="card-body">
        <div class="mb-3">
          <select v-model="selectedSubject" @change="loadChapters" class="form-select mb-2">
            <option disabled value="">Select Subject to see Chapters…</option>
            <option v-for="s in subjects" :value="s.id">{{ s.name }}</option>
          </select>
          <div class="input-group mb-3">
            <input v-model="newChapter.name" class="form-control" placeholder="New Chapter Name">
            <button class="btn btn-primary" @click="createChapter">Add</button>
          </div>
        </div>
        <table class="table table-sm table-striped">
          <thead><tr><th>ID</th><th>Subject</th><th>Name</th><th>Actions</th></tr></thead>
          <tbody>
            <tr v-for="c in chapters" :key="c.id">
              <td>{{ c.id }}</td>
              <td>
                <select v-model="c.subject_id" class="form-select form-select-sm">
                  <option v-for="s in subjects" :value="s.id">{{ s.name }}</option>
                </select>
              </td>
              <td><input v-model="c.name" class="form-control form-control-sm"></td>
              <td>
                <button class="btn btn-sm btn-success me-1" @click="updateChapter(c)">Save</button>
                <button class="btn btn-sm btn-danger" @click="deleteChapter(c.id)">Delete</button>
              </td>
            </tr>
            <tr v-if="!chapters.length"><td colspan="4" class="text-center text-muted">No chapters for this subject.</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <div class="card-header">Quizzes</div>
      <div class="card-body">
        <div class="mb-3">
          <select v-model="selectedChapter" @change="loadQuizzes" class="form-select mb-2">
            <option disabled value="">Select Chapter to see Quizzes…</option>
            <option v-for="c in chapters" :value="c.id">{{ c.name }}</option>
          </select>
          <div class="input-group mb-3">
            <input v-model="newQuiz.date_of_quiz" type="date" class="form-control">
            <input v-model="newQuiz.time_duration" type="time" class="form-control">
            <button class="btn btn-primary" @click="createQuiz">Add</button>
          </div>
        </div>
        <table class="table table-sm table-striped">
          <thead><tr><th>ID</th><th>Chapter</th><th>Date</th><th>Duration</th><th>Actions</th></tr></thead>
          <tbody>
            <tr v-for="q in quizzes" :key="q.id">
              <td>{{ q.id }}</td>
              <td>
                <select v-model="q.chapter_id" class="form-select form-select-sm">
                  <option v-for="c in chapters" :value="c.id">{{ c.name }}</option>
                </select>
              </td>
              <td><input v-model="q.date_of_quiz" type="date" class="form-control form-control-sm"></td>
              <td><input v-model="q.time_duration" type="time" class="form-control form-control-sm"></td>
              <td>
                <button class="btn btn-sm btn-success me-1" @click="updateQuiz(q)">Save</button>
                <button class="btn btn-sm btn-danger" @click="deleteQuiz(q.id)">Delete</button>
              </td>
            </tr>
            <tr v-if="!quizzes.length"><td colspan="5" class="text-center text-muted">No quizzes for this chapter.</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <div class="card-header">Questions</div>
      <div class="card-body">
        <div class="mb-3 d-flex gap-2">
          <select v-model="selectedQuiz" @change="loadQuestions" class="form-select">
            <option disabled value="">Select Quiz to see Questions…</option>
            <option v-for="q in quizzes" :value="q.id">Quiz #{{ q.id }}</option>
          </select>
          <button class="btn btn-success flex-shrink-0" @click="addQuestion">+ Add</button>
        </div>
        <div v-if="questions.length">
          <div v-for="(qt, index) in questions" :key="qt.tempId" class="mb-3 p-3 border rounded">
            <textarea v-model="qt.question_statement" class="form-control mb-2" rows="2" placeholder="Question"></textarea>
            <div class="row g-2 mb-2">
              <div class="col-md-6" v-for="(opt, i) in ['option1','option2','option3','option4']">
                <input v-model="qt[opt]" class="form-control" :placeholder="'Option ' + (i+1)">
              </div>
            </div>
            <select v-model="qt.correct_option" class="form-select mb-2">
              <option disabled value="">Select Correct Answer…</option>
              <option v-for="opt of [qt.option1,qt.option2,qt.option3,qt.option4].filter(Boolean)" :value="opt">{{ opt }}</option>
            </select>
            <div>
              <button class="btn btn-sm btn-success me-1" @click="updateQuestion(qt)">Save</button>
              <button class="btn btn-sm btn-danger" @click="deleteQuestion(qt, index)">Delete</button>
            </div>
          </div>
        </div>
        <div v-else class="text-center text-muted">No questions for this quiz.</div>
      </div>
    </div>

    <div class="modal fade" id="scoresModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">History for User #{{ activeUserId }}</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body p-0">
            <table class="table table-striped table-sm m-0">
              <thead><tr><th>Quiz</th><th>Date</th><th>Score</th></tr></thead>
              <tbody>
                <tr v-for="h in userScores" :key="h.score_id">
                  <td>{{ h.quiz_id }}</td>
                  <td>{{ new Date(h.date).toLocaleString() }}</td>
                  <td>{{ h.score }}</td>
                </tr>
                <tr v-if="!userScores.length"><td colspan="3" class="text-center text-muted p-3">No data.</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const API_BASE = 'https://66afec29-6c20-4baf-8a1a-f6cee1443d8a-00-3pmv7k9xm73vd.pike.replit.dev';
  const AUTH_HEADER = { 'Authorization': 'admin-secret-token' };

  new Vue({
    el: '#adminApp',
    data: {
      users: [], userSearch: '',
      subjects: [], newSubject: { name: '', description: '' },
      chapters: [], newChapter: { name: '' },
      quizzes: [], newQuiz: { date_of_quiz: '', time_duration: '00:10:00' },
      selectedSubject: '', selectedChapter: '', selectedQuiz: '',
      questions: [],
      activeUserId: null,
      userScores: [],
      scoresModal: null,
      toast: { visible: false, message: '', variant: 'success' }
    },
    mounted() {
      this.scoresModal = new bootstrap.Modal(document.getElementById('scoresModal'));
      this.loadUsers();
      this.loadSubjects();
    },
    methods: {
      showToast(msg, variant = 'success') {
        Object.assign(this.toast, { visible: true, message: msg, variant });
        setTimeout(() => this.toast.visible = false, 3000);
      },

      /**
       * A robust fetch handler to check for API errors and provide better logs.
       */
      async apiCall(url, options = {}) {
        try {
          const response = await fetch(url, {
            ...options,
            headers: {
              ...AUTH_HEADER,
              'Content-Type': 'application/json',
              ...options.headers,
            },
          });
          if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`API Error (${response.status}): ${errorText}`);
          }
          // Return an empty object for 204 No Content responses
          return response.status === 204 ? {} : response.json();
        } catch (err) {
          console.error(`Failed API call to ${url}:`, err);
          this.showToast(err.message || 'A network error occurred.', 'danger');
          throw err; // Re-throw the error to be caught by the calling function
        }
      },

      /* USERS */
      async loadUsers() {
        try {
          const data = await this.apiCall(`${API_BASE}/users?q=${encodeURIComponent(this.userSearch)}`);
          // Be flexible with API response: check for a 'users' key or assume the response is the array
          this.users = data.users || data || [];
        } catch (err) {
          // The error toast is already shown by apiCall
        }
      },
      async openScoresModal(id) {
        this.activeUserId = id;
        try {
          const data = await this.apiCall(`${API_BASE}/user/${id}/scores`);
          this.userScores = data.history || [];
          this.scoresModal.show();
        } catch (err) {
            // Error is handled by apiCall
        }
      },

      /* SUBJECTS */
      async loadSubjects() {
        try {
          const data = await this.apiCall(`${API_BASE}/subjects`);
          this.subjects = data.subjects || [];
          if (this.subjects.length) {
            this.selectedSubject = this.subjects[0].id;
            await this.loadChapters();
          }
        } catch (err) {}
      },
      async createSubject() {
        try {
          await this.apiCall(`${API_BASE}/subject`, {
            method: 'POST',
            body: JSON.stringify(this.newSubject)
          });
          this.newSubject = { name: '', description: '' };
          await this.loadSubjects();
          this.showToast('Subject added');
        } catch (err) {}
      },
      async updateSubject(s) {
        try {
          await this.apiCall(`${API_BASE}/subject/${s.id}`, {
            method: 'PUT',
            body: JSON.stringify({ name: s.name, description: s.description })
          });
          this.showToast('Saved');
        } catch (err) {}
      },
      async deleteSubject(id) {
        if (!confirm('Delete subject?')) return;
        try {
          await this.apiCall(`${API_BASE}/subject/${id}`, { method: 'DELETE' });
          await this.loadSubjects();
          this.showToast('Deleted');
        } catch (err) {}
      },

      /* CHAPTERS */
      async loadChapters() {
        this.chapters = []; this.quizzes = []; this.questions = [];
        if (!this.selectedSubject) return;
        try {
          const data = await this.apiCall(`${API_BASE}/subjects/${this.selectedSubject}/chapters`);
          this.chapters = data.chapters || [];
          if (this.chapters.length) {
            this.selectedChapter = this.chapters[0].id;
            await this.loadQuizzes();
          }
        } catch (err) {}
      },
      async createChapter() {
        if (!this.selectedSubject) return this.showToast('Select a subject first', 'warning');
        try {
          await this.apiCall(`${API_BASE}/chapter`, {
            method: 'POST',
            body: JSON.stringify({ subject_id: this.selectedSubject, name: this.newChapter.name })
          });
          this.newChapter.name = '';
          await this.loadChapters();
          this.showToast('Chapter added');
        } catch (err) {}
      },
      async updateChapter(c) {
        try {
          await this.apiCall(`${API_BASE}/chapter/${c.id}`, {
            method: 'PUT',
            body: JSON.stringify({ name: c.name, subject_id: c.subject_id })
          });
          this.showToast('Saved');
        } catch(err) {}
      },
      async deleteChapter(id) {
        if (!confirm('Delete chapter?')) return;
        try {
          await this.apiCall(`${API_BASE}/chapter/${id}`, { method: 'DELETE' });
          await this.loadChapters();
          this.showToast('Deleted');
        } catch(err) {}
      },

      /* QUIZZES */
      async loadQuizzes() {
        this.quizzes = []; this.questions = [];
        if (!this.selectedChapter) return;
        try {
          const data = await this.apiCall(`${API_BASE}/chapters/${this.selectedChapter}/quizzes`);
          this.quizzes = data.quizzes || [];
          this.selectedQuiz = this.quizzes.length ? this.quizzes[0].id : '';
          if (this.selectedQuiz) await this.loadQuestions();
        } catch (err) {}
      },
      async createQuiz() {
        if (!this.selectedChapter) return this.showToast('Select a chapter first.', 'warning');
        try {
          await this.apiCall(`${API_BASE}/quiz`, {
            method: 'POST',
            body: JSON.stringify({ ...this.newQuiz, chapter_id: this.selectedChapter })
          });
          this.newQuiz = { date_of_quiz: '', time_duration: '00:10:00' };
          await this.loadQuizzes();
          this.showToast('Quiz added');
        } catch (err) {}
      },
      async updateQuiz(q) {
        try {
          await this.apiCall(`${API_BASE}/quiz/${q.id}`, {
            method: 'PUT',
            body: JSON.stringify(q)
          });
          this.showToast('Saved');
        } catch (err) {}
      },
      async deleteQuiz(id) {
        if (!confirm('Delete quiz?')) return;
        try {
          await this.apiCall(`${API_BASE}/quiz/${id}`, { method: 'DELETE' });
          await this.loadQuizzes();
          this.showToast('Deleted');
        } catch (err) {}
      },

      /* QUESTIONS */
      async loadQuestions() {
        this.questions = [];
        if (!this.selectedQuiz) return;
        try {
          const data = await this.apiCall(`${API_BASE}/quiz/${this.selectedQuiz}/questions`);
          this.questions = (data.questions || []).map(q => ({
            id: q.id, tempId: `t${Math.random()}`,
            question_statement: q.question_statement,
            option1: q.options[0] || '', option2: q.options[1] || '',
            option3: q.options[2] || '', option4: q.options[3] || '',
            correct_option: q.correct_option || ''
          }));
        } catch (err) {}
      },
      addQuestion() {
        if (!this.selectedQuiz) return this.showToast('Select a quiz first.', 'warning');
        this.questions.unshift({
          id: null, tempId: `t${Date.now()}`,
          question_statement: '', option1: '', option2: '', option3: '', option4: '',
          correct_option: ''
        });
      },
      async updateQuestion(q) {
        const url = q.id ? `${API_BASE}/question/${q.id}` : `${API_BASE}/question`;
        const method = q.id ? 'PUT' : 'POST';

        const payload = {
          quiz_id: this.selectedQuiz,
          question_statement: q.question_statement,
          option1: q.option1,
          option2: q.option2,
          option3: q.option3,
          option4: q.option4,
          correct_option: q.correct_option
        };

        try {
          const data = await this.apiCall(url, {
            method,
            body: JSON.stringify(payload)
          });
          if (!q.id) {
            q.id = data.question_id; // Assign the new ID from the DB
          }
          this.showToast('Question saved successfully');
        } catch(err) {}
      },
      async deleteQuestion(question, index) {
        try {
          if (question.id) { // Only call API if it's a saved question
            if (!confirm('Delete this question from the database?')) return;
            await this.apiCall(`${API_BASE}/question/${question.id}`, { method: 'DELETE' });
          }
          this.questions.splice(index, 1);
          this.showToast('Deleted');
        } catch(err) {}
      }
    }
  });
</script>
</body>
</html>
```